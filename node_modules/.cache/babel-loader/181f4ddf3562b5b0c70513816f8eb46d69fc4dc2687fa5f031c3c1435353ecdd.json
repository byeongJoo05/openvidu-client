{"ast":null,"code":"\"use strict\";\n\n/*\n * (C) Copyright 2017-2022 OpenVidu (https://openvidu.io)\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *   http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n *\n */\nvar __extends = this && this.__extends || function () {\n  var _extendStatics = function extendStatics(d, b) {\n    _extendStatics = Object.setPrototypeOf || {\n      __proto__: []\n    } instanceof Array && function (d, b) {\n      d.__proto__ = b;\n    } || function (d, b) {\n      for (var p in b) if (Object.prototype.hasOwnProperty.call(b, p)) d[p] = b[p];\n    };\n    return _extendStatics(d, b);\n  };\n  return function (d, b) {\n    if (typeof b !== \"function\" && b !== null) throw new TypeError(\"Class extends value \" + String(b) + \" is not a constructor or null\");\n    _extendStatics(d, b);\n    function __() {\n      this.constructor = d;\n    }\n    d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());\n  };\n}();\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\nexports.StreamManager = void 0;\nvar EventDispatcher_1 = require(\"./EventDispatcher\");\nvar StreamManagerEvent_1 = require(\"../OpenViduInternal/Events/StreamManagerEvent\");\nvar VideoElementEvent_1 = require(\"../OpenViduInternal/Events/VideoElementEvent\");\nvar ExceptionEvent_1 = require(\"../OpenViduInternal/Events/ExceptionEvent\");\nvar VideoInsertMode_1 = require(\"../OpenViduInternal/Enums/VideoInsertMode\");\nvar OpenViduLogger_1 = require(\"../OpenViduInternal/Logger/OpenViduLogger\");\nvar Platform_1 = require(\"../OpenViduInternal/Utils/Platform\");\n/**\n * @hidden\n */\nvar logger = OpenViduLogger_1.OpenViduLogger.getInstance();\n/**\n * @hidden\n */\nvar platform;\n/**\n * Interface in charge of displaying the media streams in the HTML DOM. This wraps any {@link Publisher} and {@link Subscriber} object.\n * You can insert as many video players fo the same Stream as you want by calling {@link StreamManager.addVideoElement} or\n * {@link StreamManager.createVideoElement}.\n * The use of StreamManager wrapper is particularly useful when you don't need to differentiate between Publisher or Subscriber streams or just\n * want to directly manage your own video elements (even more than one video element per Stream). This scenario is pretty common in\n * declarative, MVC frontend frameworks such as Angular, React or Vue.js\n *\n * See available event listeners at {@link StreamManagerEventMap}.\n */\nvar StreamManager = /** @class */function (_super) {\n  __extends(StreamManager, _super);\n  /**\n   * @hidden\n   */\n  function StreamManager(stream, targetElement) {\n    var _this = _super.call(this) || this;\n    /**\n     * All the videos displaying the Stream of this Publisher/Subscriber\n     */\n    _this.videos = [];\n    /**\n     * @hidden\n     */\n    _this.lazyLaunchVideoElementCreatedEvent = false;\n    platform = Platform_1.PlatformUtils.getInstance();\n    _this.stream = stream;\n    _this.stream.streamManager = _this;\n    _this.remote = !_this.stream.isLocal();\n    if (!!targetElement) {\n      var targEl = void 0;\n      if (typeof targetElement === 'string') {\n        targEl = document.getElementById(targetElement);\n      } else if (targetElement instanceof HTMLElement) {\n        targEl = targetElement;\n      }\n      if (!!targEl) {\n        _this.firstVideoElement = {\n          targetElement: targEl,\n          video: document.createElement('video'),\n          id: '',\n          canplayListenerAdded: false\n        };\n        if (platform.isSafariBrowser() || platform.isIPhoneOrIPad() && (platform.isChromeMobileBrowser() || platform.isEdgeMobileBrowser() || platform.isOperaMobileBrowser() || platform.isFirefoxMobileBrowser())) {\n          _this.firstVideoElement.video.playsInline = true;\n        }\n        _this.targetElement = targEl;\n        _this.element = targEl;\n      }\n    }\n    _this.canPlayListener = function () {\n      _this.deactivateStreamPlayingEventExceptionTimeout();\n      _this.ee.emitEvent('streamPlaying', [new StreamManagerEvent_1.StreamManagerEvent(_this, 'streamPlaying', undefined)]);\n    };\n    return _this;\n  }\n  /**\n   * See {@link EventDispatcher.on}\n   */\n  StreamManager.prototype.on = function (type, handler) {\n    _super.prototype.onAux.call(this, type, \"Event '\" + type + \"' triggered by '\" + (this.remote ? 'Subscriber' : 'Publisher') + \"'\", handler);\n    if (type === 'videoElementCreated') {\n      if (!!this.stream && this.lazyLaunchVideoElementCreatedEvent) {\n        this.ee.emitEvent('videoElementCreated', [new VideoElementEvent_1.VideoElementEvent(this.videos[0].video, this, 'videoElementCreated')]);\n        this.lazyLaunchVideoElementCreatedEvent = false;\n      }\n    }\n    if (type === 'streamPlaying') {\n      if (this.videos[0] && this.videos[0].video && this.videos[0].video.currentTime > 0 && this.videos[0].video.paused === false && this.videos[0].video.ended === false && this.videos[0].video.readyState === 4) {\n        this.ee.emitEvent('streamPlaying', [new StreamManagerEvent_1.StreamManagerEvent(this, 'streamPlaying', undefined)]);\n      }\n    }\n    if (this.stream.hasAudio) {\n      if (type === 'publisherStartSpeaking') {\n        this.stream.enableHarkSpeakingEvent();\n      }\n      if (type === 'publisherStopSpeaking') {\n        this.stream.enableHarkStoppedSpeakingEvent();\n      }\n      if (type === 'streamAudioVolumeChange') {\n        this.stream.enableHarkVolumeChangeEvent(false);\n      }\n    }\n    return this;\n  };\n  /**\n   * See {@link EventDispatcher.once}\n   */\n  StreamManager.prototype.once = function (type, handler) {\n    _super.prototype.onceAux.call(this, type, \"Event '\" + type + \"' triggered once by '\" + (this.remote ? 'Subscriber' : 'Publisher') + \"'\", handler);\n    if (type === 'videoElementCreated') {\n      if (!!this.stream && this.lazyLaunchVideoElementCreatedEvent) {\n        this.ee.emitEvent('videoElementCreated', [new VideoElementEvent_1.VideoElementEvent(this.videos[0].video, this, 'videoElementCreated')]);\n      }\n    }\n    if (type === 'streamPlaying') {\n      if (this.videos[0] && this.videos[0].video && this.videos[0].video.currentTime > 0 && this.videos[0].video.paused === false && this.videos[0].video.ended === false && this.videos[0].video.readyState === 4) {\n        this.ee.emitEvent('streamPlaying', [new StreamManagerEvent_1.StreamManagerEvent(this, 'streamPlaying', undefined)]);\n      }\n    }\n    if (this.stream.hasAudio) {\n      if (type === 'publisherStartSpeaking') {\n        this.stream.enableOnceHarkSpeakingEvent();\n      }\n      if (type === 'publisherStopSpeaking') {\n        this.stream.enableOnceHarkStoppedSpeakingEvent();\n      }\n      if (type === 'streamAudioVolumeChange') {\n        this.stream.enableOnceHarkVolumeChangeEvent(false);\n      }\n    }\n    return this;\n  };\n  /**\n   * See {@link EventDispatcher.off}\n   */\n  StreamManager.prototype.off = function (type, handler) {\n    _super.prototype.offAux.call(this, type, handler);\n    if (type === 'publisherStartSpeaking') {\n      // Both StreamManager and Session can have \"publisherStartSpeaking\" event listeners\n      var remainingStartSpeakingEventListeners = this.ee.getListeners(type).length + this.stream.session.ee.getListeners(type).length;\n      if (remainingStartSpeakingEventListeners === 0) {\n        this.stream.disableHarkSpeakingEvent(false);\n      }\n    }\n    if (type === 'publisherStopSpeaking') {\n      // Both StreamManager and Session can have \"publisherStopSpeaking\" event listeners\n      var remainingStopSpeakingEventListeners = this.ee.getListeners(type).length + this.stream.session.ee.getListeners(type).length;\n      if (remainingStopSpeakingEventListeners === 0) {\n        this.stream.disableHarkStoppedSpeakingEvent(false);\n      }\n    }\n    if (type === 'streamAudioVolumeChange') {\n      // Only StreamManager can have \"streamAudioVolumeChange\" event listeners\n      var remainingVolumeEventListeners = this.ee.getListeners(type).length;\n      if (remainingVolumeEventListeners === 0) {\n        this.stream.disableHarkVolumeChangeEvent(false);\n      }\n    }\n    return this;\n  };\n  /**\n   * Makes `video` element parameter display this {@link stream}. This is useful when you are\n   * [managing the video elements on your own](/en/stable/cheatsheet/manage-videos/#you-take-care-of-the-video-players)\n   *\n   * Calling this method with a video already added to other Publisher/Subscriber will cause the video element to be\n   * disassociated from that previous Publisher/Subscriber and to be associated to this one.\n   *\n   * @returns 1 if the video wasn't associated to any other Publisher/Subscriber and has been successfully added to this one.\n   * 0 if the video was already added to this Publisher/Subscriber. -1 if the video was previously associated to any other\n   * Publisher/Subscriber and has been successfully disassociated from that one and properly added to this one.\n   */\n  StreamManager.prototype.addVideoElement = function (video) {\n    this.initializeVideoProperties(video);\n    if (!this.remote && this.stream.displayMyRemote()) {\n      if (video.srcObject !== this.stream.getMediaStream()) {\n        video.srcObject = this.stream.getMediaStream();\n      }\n    }\n    // If the video element is already part of this StreamManager do nothing\n    for (var _i = 0, _a = this.videos; _i < _a.length; _i++) {\n      var v = _a[_i];\n      if (v.video === video) {\n        return 0;\n      }\n    }\n    var returnNumber = 1;\n    for (var _b = 0, _c = this.stream.session.streamManagers; _b < _c.length; _b++) {\n      var streamManager = _c[_b];\n      if (streamManager.disassociateVideo(video)) {\n        returnNumber = -1;\n        break;\n      }\n    }\n    this.stream.session.streamManagers.forEach(function (streamManager) {\n      streamManager.disassociateVideo(video);\n    });\n    this.pushNewStreamManagerVideo({\n      video: video,\n      id: video.id,\n      canplayListenerAdded: false\n    });\n    logger.info('New video element associated to ', this);\n    return returnNumber;\n  };\n  /**\n   * Creates a new video element displaying this {@link stream}. This allows you to have multiple video elements displaying the same media stream.\n   *\n   * #### Events dispatched\n   *\n   * The Publisher/Subscriber object will dispatch a `videoElementCreated` event once the HTML video element has been added to DOM. See {@link VideoElementEvent}\n   *\n   * @param targetElement HTML DOM element (or its `id` attribute) in which the video element of the Publisher/Subscriber will be inserted\n   * @param insertMode How the video element will be inserted accordingly to `targetElemet`\n   *\n   * @returns The created HTMLVideoElement\n   */\n  StreamManager.prototype.createVideoElement = function (targetElement, insertMode) {\n    var targEl;\n    if (typeof targetElement === 'string') {\n      targEl = document.getElementById(targetElement);\n      if (!targEl) {\n        throw new Error(\"The provided 'targetElement' couldn't be resolved to any HTML element: \" + targetElement);\n      }\n    } else if (targetElement instanceof HTMLElement) {\n      targEl = targetElement;\n    } else {\n      throw new Error(\"The provided 'targetElement' couldn't be resolved to any HTML element: \" + targetElement);\n    }\n    var video = this.createVideo();\n    this.initializeVideoProperties(video);\n    var insMode = !!insertMode ? insertMode : VideoInsertMode_1.VideoInsertMode.APPEND;\n    switch (insMode) {\n      case VideoInsertMode_1.VideoInsertMode.AFTER:\n        targEl.parentNode.insertBefore(video, targEl.nextSibling);\n        break;\n      case VideoInsertMode_1.VideoInsertMode.APPEND:\n        targEl.appendChild(video);\n        break;\n      case VideoInsertMode_1.VideoInsertMode.BEFORE:\n        targEl.parentNode.insertBefore(video, targEl);\n        break;\n      case VideoInsertMode_1.VideoInsertMode.PREPEND:\n        targEl.insertBefore(video, targEl.childNodes[0]);\n        break;\n      case VideoInsertMode_1.VideoInsertMode.REPLACE:\n        targEl.parentNode.replaceChild(video, targEl);\n        break;\n      default:\n        insMode = VideoInsertMode_1.VideoInsertMode.APPEND;\n        targEl.appendChild(video);\n        break;\n    }\n    var v = {\n      targetElement: targEl,\n      video: video,\n      insertMode: insMode,\n      id: video.id,\n      canplayListenerAdded: false\n    };\n    this.pushNewStreamManagerVideo(v);\n    this.ee.emitEvent('videoElementCreated', [new VideoElementEvent_1.VideoElementEvent(v.video, this, 'videoElementCreated')]);\n    this.lazyLaunchVideoElementCreatedEvent = !!this.firstVideoElement;\n    return video;\n  };\n  /**\n   * Updates the current configuration for the {@link PublisherSpeakingEvent} feature and the [StreamManagerEvent.streamAudioVolumeChange](/en/stable/api/openvidu-browser/classes/StreamManagerEvent.html) feature for this specific\n   * StreamManager audio stream, overriding the global options set with {@link OpenVidu.setAdvancedConfiguration}. This way you can customize the audio events options\n   * for each specific StreamManager and change them dynamically.\n   *\n   * @param publisherSpeakingEventsOptions New options to be applied to this StreamManager's audio stream. It is an object which includes the following optional properties:\n   * - `interval`: (number) how frequently the analyser polls the audio stream to check if speaking has started/stopped or audio volume has changed. Default **100** (ms)\n   * - `threshold`: (number) the volume at which _publisherStartSpeaking_, _publisherStopSpeaking_ events will be fired. Default **-50** (dB)\n   */\n  StreamManager.prototype.updatePublisherSpeakingEventsOptions = function (publisherSpeakingEventsOptions) {\n    var currentHarkOptions = !!this.stream.harkOptions ? this.stream.harkOptions : this.stream.session.openvidu.advancedConfiguration.publisherSpeakingEventsOptions || {};\n    var newInterval = typeof publisherSpeakingEventsOptions.interval === 'number' ? publisherSpeakingEventsOptions.interval : typeof currentHarkOptions.interval === 'number' ? currentHarkOptions.interval : 100;\n    var newThreshold = typeof publisherSpeakingEventsOptions.threshold === 'number' ? publisherSpeakingEventsOptions.threshold : typeof currentHarkOptions.threshold === 'number' ? currentHarkOptions.threshold : -50;\n    this.stream.harkOptions = {\n      interval: newInterval,\n      threshold: newThreshold\n    };\n    if (!!this.stream.speechEvent) {\n      this.stream.speechEvent.setInterval(newInterval);\n      this.stream.speechEvent.setThreshold(newThreshold);\n    }\n  };\n  /* Hidden methods */\n  /**\n   * @hidden\n   */\n  StreamManager.prototype.initializeVideoProperties = function (video) {\n    if (!(!this.remote && this.stream.displayMyRemote())) {\n      // Avoid setting the MediaStream into the srcObject if remote subscription before publishing\n      if (video.srcObject !== this.stream.getMediaStream()) {\n        // If srcObject already set don't do it again\n        video.srcObject = this.stream.getMediaStream();\n      }\n    }\n    video.autoplay = true;\n    video.controls = false;\n    if (platform.isSafariBrowser() || platform.isIPhoneOrIPad() && (platform.isChromeMobileBrowser() || platform.isEdgeMobileBrowser() || platform.isOperaMobileBrowser() || platform.isFirefoxMobileBrowser())) {\n      video.playsInline = true;\n    }\n    if (!video.id) {\n      video.id = (this.remote ? 'remote-' : 'local-') + 'video-' + this.stream.streamId;\n      // DEPRECATED property: assign once the property id if the user provided a valid targetElement\n      if (!this.id && !!this.targetElement) {\n        this.id = video.id;\n      }\n    }\n    if (this.remote && this.isMirroredVideo(video)) {\n      // Subscriber video associated to a previously mirrored video element\n      this.removeMirrorVideo(video);\n    } else if (!this.remote && !this.stream.displayMyRemote()) {\n      // Publisher video\n      video.muted = true;\n      if (this.isMirroredVideo(video) && !this.stream.outboundStreamOpts.publisherProperties.mirror) {\n        // If the video was already rotated and now is set to not mirror\n        this.removeMirrorVideo(video);\n      } else if (this.stream.outboundStreamOpts.publisherProperties.mirror && !this.stream.isSendScreen()) {\n        // If the video is now set to mirror and is not screen share\n        this.mirrorVideo(video);\n      }\n    }\n  };\n  /**\n   * @hidden\n   */\n  StreamManager.prototype.removeAllVideos = function () {\n    var _this = this;\n    for (var i = this.stream.session.streamManagers.length - 1; i >= 0; --i) {\n      if (this.stream.session.streamManagers[i] === this) {\n        this.stream.session.streamManagers.splice(i, 1);\n      }\n    }\n    this.videos.forEach(function (streamManagerVideo) {\n      // Remove oncanplay event listener (only OpenVidu browser listener, not the user ones)\n      if (!!streamManagerVideo.video && !!streamManagerVideo.video.removeEventListener) {\n        streamManagerVideo.video.removeEventListener('canplay', _this.canPlayListener);\n      }\n      streamManagerVideo.canplayListenerAdded = false;\n      if (!!streamManagerVideo.targetElement) {\n        // Only remove from DOM videos created by OpenVidu Browser (those generated by passing a valid targetElement in OpenVidu.initPublisher\n        // and Session.subscribe or those created by StreamManager.createVideoElement). All this videos triggered a videoElementCreated event\n        streamManagerVideo.video.parentNode.removeChild(streamManagerVideo.video);\n        _this.ee.emitEvent('videoElementDestroyed', [new VideoElementEvent_1.VideoElementEvent(streamManagerVideo.video, _this, 'videoElementDestroyed')]);\n      }\n      // Remove srcObject from the video\n      _this.removeSrcObject(streamManagerVideo);\n      // Remove from collection of videos every video managed by OpenVidu Browser\n      _this.videos.filter(function (v) {\n        return !v.targetElement;\n      });\n    });\n  };\n  /**\n   * @hidden\n   */\n  StreamManager.prototype.disassociateVideo = function (video) {\n    var disassociated = false;\n    for (var i = 0; i < this.videos.length; i++) {\n      if (this.videos[i].video === video) {\n        this.videos[i].video.removeEventListener('canplay', this.canPlayListener);\n        this.videos.splice(i, 1);\n        disassociated = true;\n        logger.info('Video element disassociated from ', this);\n        break;\n      }\n    }\n    return disassociated;\n  };\n  /**\n   * @hidden\n   */\n  StreamManager.prototype.addPlayEventToFirstVideo = function () {\n    if (!!this.videos[0] && !!this.videos[0].video && !this.videos[0].canplayListenerAdded) {\n      this.activateStreamPlayingEventExceptionTimeout();\n      this.videos[0].video.addEventListener('canplay', this.canPlayListener);\n      this.videos[0].canplayListenerAdded = true;\n    }\n  };\n  /**\n   * @hidden\n   */\n  StreamManager.prototype.updateMediaStream = function (mediaStream) {\n    this.videos.forEach(function (streamManagerVideo) {\n      streamManagerVideo.video.srcObject = mediaStream;\n      if (platform.isIonicIos()) {\n        // iOS Ionic. LIMITATION: must reinsert the video in the DOM for\n        // the media stream to be updated\n        var vParent = streamManagerVideo.video.parentElement;\n        var newVideo = streamManagerVideo.video;\n        vParent.replaceChild(newVideo, streamManagerVideo.video);\n        streamManagerVideo.video = newVideo;\n      }\n    });\n  };\n  /**\n   * @hidden\n   */\n  StreamManager.prototype.emitEvent = function (type, eventArray) {\n    this.ee.emitEvent(type, eventArray);\n  };\n  /**\n   * @hidden\n   */\n  StreamManager.prototype.createVideo = function () {\n    return document.createElement('video');\n  };\n  /**\n   * @hidden\n   */\n  StreamManager.prototype.removeSrcObject = function (streamManagerVideo) {\n    streamManagerVideo.video.srcObject = null;\n    this.deactivateStreamPlayingEventExceptionTimeout();\n  };\n  /* Private methods */\n  StreamManager.prototype.pushNewStreamManagerVideo = function (streamManagerVideo) {\n    this.videos.push(streamManagerVideo);\n    this.addPlayEventToFirstVideo();\n    if (this.stream.session.streamManagers.indexOf(this) === -1) {\n      this.stream.session.streamManagers.push(this);\n    }\n  };\n  StreamManager.prototype.mirrorVideo = function (video) {\n    if (!platform.isIonicIos()) {\n      video.style.transform = 'rotateY(180deg)';\n      video.style.webkitTransform = 'rotateY(180deg)';\n    }\n  };\n  StreamManager.prototype.removeMirrorVideo = function (video) {\n    video.style.transform = 'unset';\n    video.style.webkitTransform = 'unset';\n  };\n  StreamManager.prototype.isMirroredVideo = function (video) {\n    return video.style.transform === 'rotateY(180deg)' || video.style.webkitTransform === 'rotateY(180deg)';\n  };\n  StreamManager.prototype.activateStreamPlayingEventExceptionTimeout = function () {\n    var _this = this;\n    if (!this.remote) {\n      // ExceptionEvent NO_STREAM_PLAYING_EVENT is only for subscribers\n      return;\n    }\n    if (this.streamPlayingEventExceptionTimeout != null) {\n      // The timeout is already activated\n      return;\n    }\n    // Trigger ExceptionEvent NO_STREAM_PLAYING_EVENT if after timeout there is no 'canplay' event\n    var msTimeout = this.stream.session.openvidu.advancedConfiguration.noStreamPlayingEventExceptionTimeout || 4000;\n    this.streamPlayingEventExceptionTimeout = setTimeout(function () {\n      var msg = 'StreamManager of Stream ' + _this.stream.streamId + ' (' + (_this.remote ? 'Subscriber' : 'Publisher') + ') did not trigger \"streamPlaying\" event in ' + msTimeout + ' ms';\n      logger.warn(msg);\n      _this.stream.session.emitEvent('exception', [new ExceptionEvent_1.ExceptionEvent(_this.stream.session, ExceptionEvent_1.ExceptionEventName.NO_STREAM_PLAYING_EVENT, _this, msg)]);\n      delete _this.streamPlayingEventExceptionTimeout;\n    }, msTimeout);\n  };\n  StreamManager.prototype.deactivateStreamPlayingEventExceptionTimeout = function () {\n    clearTimeout(this.streamPlayingEventExceptionTimeout);\n    delete this.streamPlayingEventExceptionTimeout;\n  };\n  return StreamManager;\n}(EventDispatcher_1.EventDispatcher);\nexports.StreamManager = StreamManager;","map":{"version":3,"mappings":";;AAAA;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAmBA;AAGA;AACA;AACA;AACA;AACA;AACA;AAEA;;;AAGA,IAAMA,MAAM,GAAmBC,+BAAc,CAACC,WAAW,EAAE;AAE3D;;;AAGA,IAAIC,QAAuB;AAE3B;;;;;;;;;;AAUA;EAA4CC;EAqDxC;;;EAGA,uBAAYC,MAAc,EAAEC,aAAoC;IAAhE,YACIC,iBAAO;IAnDX;;;IAGAC,YAAM,GAAyB,EAAE;IAuCjC;;;IAGQA,wCAAkC,GAAG,KAAK;IAO9CL,QAAQ,GAAGM,wBAAa,CAACP,WAAW,EAAE;IACtCM,KAAI,CAACH,MAAM,GAAGA,MAAM;IACpBG,KAAI,CAACH,MAAM,CAACK,aAAa,GAAGF,KAAI;IAChCA,KAAI,CAACG,MAAM,GAAG,CAACH,KAAI,CAACH,MAAM,CAACO,OAAO,EAAE;IAEpC,IAAI,CAAC,CAACN,aAAa,EAAE;MACjB,IAAIO,MAAM;MACV,IAAI,OAAOP,aAAa,KAAK,QAAQ,EAAE;QACnCO,MAAM,GAAGC,QAAQ,CAACC,cAAc,CAACT,aAAa,CAAC;OAClD,MAAM,IAAIA,aAAa,YAAYU,WAAW,EAAE;QAC7CH,MAAM,GAAGP,aAAa;;MAG1B,IAAI,CAAC,CAACO,MAAM,EAAE;QACVL,KAAI,CAACS,iBAAiB,GAAG;UACrBX,aAAa,EAAEO,MAAM;UACrBK,KAAK,EAAEJ,QAAQ,CAACK,aAAa,CAAC,OAAO,CAAC;UACtCC,EAAE,EAAE,EAAE;UACNC,oBAAoB,EAAE;SACzB;QACD,IACIlB,QAAQ,CAACmB,eAAe,EAAE,IACzBnB,QAAQ,CAACoB,cAAc,EAAE,KACrBpB,QAAQ,CAACqB,qBAAqB,EAAE,IAC7BrB,QAAQ,CAACsB,mBAAmB,EAAE,IAC9BtB,QAAQ,CAACuB,oBAAoB,EAAE,IAC/BvB,QAAQ,CAACwB,sBAAsB,EAAE,CAAE,EAC7C;UACEnB,KAAI,CAACS,iBAAiB,CAACC,KAAK,CAACU,WAAW,GAAG,IAAI;;QAEnDpB,KAAI,CAACF,aAAa,GAAGO,MAAM;QAC3BL,KAAI,CAACqB,OAAO,GAAGhB,MAAM;;;IAI7BL,KAAI,CAACsB,eAAe,GAAG;MACnBtB,KAAI,CAACuB,4CAA4C,EAAE;MACnDvB,KAAI,CAACwB,EAAE,CAACC,SAAS,CAAC,eAAe,EAAE,CAAC,IAAIC,uCAAkB,CAAC1B,KAAI,EAAE,eAAe,EAAE2B,SAAS,CAAC,CAAC,CAAC;IAClG,CAAC;;EACL;EAEA;;;EAGAC,0BAAE,GAAF,UAA0CC,IAAO,EAAEC,OAAkD;IACjG/B,iBAAMgC,KAAK,YAACF,IAAI,EAAE,SAAS,GAAGA,IAAI,GAAG,kBAAkB,IAAI,IAAI,CAAC1B,MAAM,GAAG,YAAY,GAAG,WAAW,CAAC,GAAG,GAAG,EAAE2B,OAAO,CAAC;IAEpH,IAAID,IAAI,KAAK,qBAAqB,EAAE;MAChC,IAAI,CAAC,CAAC,IAAI,CAAChC,MAAM,IAAI,IAAI,CAACmC,kCAAkC,EAAE;QAC1D,IAAI,CAACR,EAAE,CAACC,SAAS,CAAC,qBAAqB,EAAE,CAAC,IAAIQ,qCAAiB,CAAC,IAAI,CAACC,MAAM,CAAC,CAAC,CAAC,CAACxB,KAAK,EAAE,IAAI,EAAE,qBAAqB,CAAC,CAAC,CAAC;QACpH,IAAI,CAACsB,kCAAkC,GAAG,KAAK;;;IAGvD,IAAIH,IAAI,KAAK,eAAe,EAAE;MAC1B,IACI,IAAI,CAACK,MAAM,CAAC,CAAC,CAAC,IACd,IAAI,CAACA,MAAM,CAAC,CAAC,CAAC,CAACxB,KAAK,IACpB,IAAI,CAACwB,MAAM,CAAC,CAAC,CAAC,CAACxB,KAAK,CAACyB,WAAW,GAAG,CAAC,IACpC,IAAI,CAACD,MAAM,CAAC,CAAC,CAAC,CAACxB,KAAK,CAAC0B,MAAM,KAAK,KAAK,IACrC,IAAI,CAACF,MAAM,CAAC,CAAC,CAAC,CAACxB,KAAK,CAAC2B,KAAK,KAAK,KAAK,IACpC,IAAI,CAACH,MAAM,CAAC,CAAC,CAAC,CAACxB,KAAK,CAAC4B,UAAU,KAAK,CAAC,EACvC;QACE,IAAI,CAACd,EAAE,CAACC,SAAS,CAAC,eAAe,EAAE,CAAC,IAAIC,uCAAkB,CAAC,IAAI,EAAE,eAAe,EAAEC,SAAS,CAAC,CAAC,CAAC;;;IAGtG,IAAI,IAAI,CAAC9B,MAAM,CAAC0C,QAAQ,EAAE;MACtB,IAAIV,IAAI,KAAK,wBAAwB,EAAE;QACnC,IAAI,CAAChC,MAAM,CAAC2C,uBAAuB,EAAE;;MAEzC,IAAIX,IAAI,KAAK,uBAAuB,EAAE;QAClC,IAAI,CAAChC,MAAM,CAAC4C,8BAA8B,EAAE;;MAEhD,IAAIZ,IAAI,KAAK,yBAAyB,EAAE;QACpC,IAAI,CAAChC,MAAM,CAAC6C,2BAA2B,CAAC,KAAK,CAAC;;;IAGtD,OAAO,IAAI;EACf,CAAC;EAED;;;EAGAd,4BAAI,GAAJ,UAA4CC,IAAO,EAAEC,OAAkD;IACnG/B,iBAAM4C,OAAO,YAACd,IAAI,EAAE,SAAS,GAAGA,IAAI,GAAG,uBAAuB,IAAI,IAAI,CAAC1B,MAAM,GAAG,YAAY,GAAG,WAAW,CAAC,GAAG,GAAG,EAAE2B,OAAO,CAAC;IAE3H,IAAID,IAAI,KAAK,qBAAqB,EAAE;MAChC,IAAI,CAAC,CAAC,IAAI,CAAChC,MAAM,IAAI,IAAI,CAACmC,kCAAkC,EAAE;QAC1D,IAAI,CAACR,EAAE,CAACC,SAAS,CAAC,qBAAqB,EAAE,CAAC,IAAIQ,qCAAiB,CAAC,IAAI,CAACC,MAAM,CAAC,CAAC,CAAC,CAACxB,KAAK,EAAE,IAAI,EAAE,qBAAqB,CAAC,CAAC,CAAC;;;IAG5H,IAAImB,IAAI,KAAK,eAAe,EAAE;MAC1B,IACI,IAAI,CAACK,MAAM,CAAC,CAAC,CAAC,IACd,IAAI,CAACA,MAAM,CAAC,CAAC,CAAC,CAACxB,KAAK,IACpB,IAAI,CAACwB,MAAM,CAAC,CAAC,CAAC,CAACxB,KAAK,CAACyB,WAAW,GAAG,CAAC,IACpC,IAAI,CAACD,MAAM,CAAC,CAAC,CAAC,CAACxB,KAAK,CAAC0B,MAAM,KAAK,KAAK,IACrC,IAAI,CAACF,MAAM,CAAC,CAAC,CAAC,CAACxB,KAAK,CAAC2B,KAAK,KAAK,KAAK,IACpC,IAAI,CAACH,MAAM,CAAC,CAAC,CAAC,CAACxB,KAAK,CAAC4B,UAAU,KAAK,CAAC,EACvC;QACE,IAAI,CAACd,EAAE,CAACC,SAAS,CAAC,eAAe,EAAE,CAAC,IAAIC,uCAAkB,CAAC,IAAI,EAAE,eAAe,EAAEC,SAAS,CAAC,CAAC,CAAC;;;IAGtG,IAAI,IAAI,CAAC9B,MAAM,CAAC0C,QAAQ,EAAE;MACtB,IAAIV,IAAI,KAAK,wBAAwB,EAAE;QACnC,IAAI,CAAChC,MAAM,CAAC+C,2BAA2B,EAAE;;MAE7C,IAAIf,IAAI,KAAK,uBAAuB,EAAE;QAClC,IAAI,CAAChC,MAAM,CAACgD,kCAAkC,EAAE;;MAEpD,IAAIhB,IAAI,KAAK,yBAAyB,EAAE;QACpC,IAAI,CAAChC,MAAM,CAACiD,+BAA+B,CAAC,KAAK,CAAC;;;IAG1D,OAAO,IAAI;EACf,CAAC;EAED;;;EAGAlB,2BAAG,GAAH,UAA2CC,IAAO,EAAEC,OAAmD;IACnG/B,iBAAMgD,MAAM,YAAClB,IAAI,EAAEC,OAAO,CAAC;IAE3B,IAAID,IAAI,KAAK,wBAAwB,EAAE;MACnC;MACA,IAAMmB,oCAAoC,GACtC,IAAI,CAACxB,EAAE,CAACyB,YAAY,CAACpB,IAAI,CAAC,CAACqB,MAAM,GAAG,IAAI,CAACrD,MAAM,CAACsD,OAAO,CAAC3B,EAAE,CAACyB,YAAY,CAACpB,IAAI,CAAC,CAACqB,MAAM;MACxF,IAAIF,oCAAoC,KAAK,CAAC,EAAE;QAC5C,IAAI,CAACnD,MAAM,CAACuD,wBAAwB,CAAC,KAAK,CAAC;;;IAGnD,IAAIvB,IAAI,KAAK,uBAAuB,EAAE;MAClC;MACA,IAAMwB,mCAAmC,GACrC,IAAI,CAAC7B,EAAE,CAACyB,YAAY,CAACpB,IAAI,CAAC,CAACqB,MAAM,GAAG,IAAI,CAACrD,MAAM,CAACsD,OAAO,CAAC3B,EAAE,CAACyB,YAAY,CAACpB,IAAI,CAAC,CAACqB,MAAM;MACxF,IAAIG,mCAAmC,KAAK,CAAC,EAAE;QAC3C,IAAI,CAACxD,MAAM,CAACyD,+BAA+B,CAAC,KAAK,CAAC;;;IAG1D,IAAIzB,IAAI,KAAK,yBAAyB,EAAE;MACpC;MACA,IAAM0B,6BAA6B,GAAG,IAAI,CAAC/B,EAAE,CAACyB,YAAY,CAACpB,IAAI,CAAC,CAACqB,MAAM;MACvE,IAAIK,6BAA6B,KAAK,CAAC,EAAE;QACrC,IAAI,CAAC1D,MAAM,CAAC2D,4BAA4B,CAAC,KAAK,CAAC;;;IAIvD,OAAO,IAAI;EACf,CAAC;EAED;;;;;;;;;;;EAWA5B,uCAAe,GAAf,UAAgBlB,KAAuB;IACnC,IAAI,CAAC+C,yBAAyB,CAAC/C,KAAK,CAAC;IAErC,IAAI,CAAC,IAAI,CAACP,MAAM,IAAI,IAAI,CAACN,MAAM,CAAC6D,eAAe,EAAE,EAAE;MAC/C,IAAIhD,KAAK,CAACiD,SAAS,KAAK,IAAI,CAAC9D,MAAM,CAAC+D,cAAc,EAAE,EAAE;QAClDlD,KAAK,CAACiD,SAAS,GAAG,IAAI,CAAC9D,MAAM,CAAC+D,cAAc,EAAE;;;IAItD;IACA,KAAgB,UAAW,EAAXC,SAAI,CAAC3B,MAAM,EAAX4B,cAAW,EAAXA,IAAW,EAAE;MAAxB,IAAMC,CAAC;MACR,IAAIA,CAAC,CAACrD,KAAK,KAAKA,KAAK,EAAE;QACnB,OAAO,CAAC;;;IAIhB,IAAIsD,YAAY,GAAG,CAAC;IAEpB,KAA4B,UAAkC,EAAlCC,SAAI,CAACpE,MAAM,CAACsD,OAAO,CAACe,cAAc,EAAlCC,cAAkC,EAAlCA,IAAkC,EAAE;MAA3D,IAAMjE,aAAa;MACpB,IAAIA,aAAa,CAACkE,iBAAiB,CAAC1D,KAAK,CAAC,EAAE;QACxCsD,YAAY,GAAG,CAAC,CAAC;QACjB;;;IAIR,IAAI,CAACnE,MAAM,CAACsD,OAAO,CAACe,cAAc,CAACG,OAAO,CAAC,UAACnE,aAAa;MACrDA,aAAa,CAACkE,iBAAiB,CAAC1D,KAAK,CAAC;IAC1C,CAAC,CAAC;IAEF,IAAI,CAAC4D,yBAAyB,CAAC;MAC3B5D,KAAK;MACLE,EAAE,EAAEF,KAAK,CAACE,EAAE;MACZC,oBAAoB,EAAE;KACzB,CAAC;IAEFrB,MAAM,CAAC+E,IAAI,CAAC,kCAAkC,EAAE,IAAI,CAAC;IAErD,OAAOP,YAAY;EACvB,CAAC;EAED;;;;;;;;;;;;EAYApC,0CAAkB,GAAlB,UAAmB9B,aAAoC,EAAE0E,UAA4B;IACjF,IAAInE,MAAM;IACV,IAAI,OAAOP,aAAa,KAAK,QAAQ,EAAE;MACnCO,MAAM,GAAGC,QAAQ,CAACC,cAAc,CAACT,aAAa,CAAC;MAC/C,IAAI,CAACO,MAAM,EAAE;QACT,MAAM,IAAIoE,KAAK,CAAC,yEAAyE,GAAG3E,aAAa,CAAC;;KAEjH,MAAM,IAAIA,aAAa,YAAYU,WAAW,EAAE;MAC7CH,MAAM,GAAGP,aAAa;KACzB,MAAM;MACH,MAAM,IAAI2E,KAAK,CAAC,yEAAyE,GAAG3E,aAAa,CAAC;;IAG9G,IAAMY,KAAK,GAAG,IAAI,CAACgE,WAAW,EAAE;IAChC,IAAI,CAACjB,yBAAyB,CAAC/C,KAAK,CAAC;IAErC,IAAIiE,OAAO,GAAG,CAAC,CAACH,UAAU,GAAGA,UAAU,GAAGI,iCAAe,CAACC,MAAM;IAChE,QAAQF,OAAO;MACX,KAAKC,iCAAe,CAACE,KAAK;QACtBzE,MAAM,CAAC0E,UAAY,CAACC,YAAY,CAACtE,KAAK,EAAEL,MAAM,CAAC4E,WAAW,CAAC;QAC3D;MACJ,KAAKL,iCAAe,CAACC,MAAM;QACvBxE,MAAM,CAAC6E,WAAW,CAACxE,KAAK,CAAC;QACzB;MACJ,KAAKkE,iCAAe,CAACO,MAAM;QACvB9E,MAAM,CAAC0E,UAAY,CAACC,YAAY,CAACtE,KAAK,EAAEL,MAAM,CAAC;QAC/C;MACJ,KAAKuE,iCAAe,CAACQ,OAAO;QACxB/E,MAAM,CAAC2E,YAAY,CAACtE,KAAK,EAAEL,MAAM,CAACgF,UAAU,CAAC,CAAC,CAAC,CAAC;QAChD;MACJ,KAAKT,iCAAe,CAACU,OAAO;QACxBjF,MAAM,CAAC0E,UAAY,CAACQ,YAAY,CAAC7E,KAAK,EAAEL,MAAM,CAAC;QAC/C;MACJ;QACIsE,OAAO,GAAGC,iCAAe,CAACC,MAAM;QAChCxE,MAAM,CAAC6E,WAAW,CAACxE,KAAK,CAAC;QACzB;IAAM;IAGd,IAAMqD,CAAC,GAAuB;MAC1BjE,aAAa,EAAEO,MAAM;MACrBK,KAAK;MACL8D,UAAU,EAAEG,OAAO;MACnB/D,EAAE,EAAEF,KAAK,CAACE,EAAE;MACZC,oBAAoB,EAAE;KACzB;IACD,IAAI,CAACyD,yBAAyB,CAACP,CAAC,CAAC;IAEjC,IAAI,CAACvC,EAAE,CAACC,SAAS,CAAC,qBAAqB,EAAE,CAAC,IAAIQ,qCAAiB,CAAC8B,CAAC,CAACrD,KAAK,EAAE,IAAI,EAAE,qBAAqB,CAAC,CAAC,CAAC;IACvG,IAAI,CAACsB,kCAAkC,GAAG,CAAC,CAAC,IAAI,CAACvB,iBAAiB;IAElE,OAAOC,KAAK;EAChB,CAAC;EAED;;;;;;;;;EASAkB,4DAAoC,GAApC,UAAqC4D,8BAAyE;IAC1G,IAAMC,kBAAkB,GAAG,CAAC,CAAC,IAAI,CAAC5F,MAAM,CAAC6F,WAAW,GAC9C,IAAI,CAAC7F,MAAM,CAAC6F,WAAW,GACvB,IAAI,CAAC7F,MAAM,CAACsD,OAAO,CAACwC,QAAQ,CAACC,qBAAqB,CAACJ,8BAA8B,IAAI,EAAE;IAC7F,IAAMK,WAAW,GACb,OAAOL,8BAA8B,CAACM,QAAQ,KAAK,QAAQ,GACrDN,8BAA8B,CAACM,QAAQ,GACvC,OAAOL,kBAAkB,CAACK,QAAQ,KAAK,QAAQ,GAC/CL,kBAAkB,CAACK,QAAQ,GAC3B,GAAG;IACb,IAAMC,YAAY,GACd,OAAOP,8BAA8B,CAACQ,SAAS,KAAK,QAAQ,GACtDR,8BAA8B,CAACQ,SAAS,GACxC,OAAOP,kBAAkB,CAACO,SAAS,KAAK,QAAQ,GAChDP,kBAAkB,CAACO,SAAS,GAC5B,CAAC,EAAE;IACb,IAAI,CAACnG,MAAM,CAAC6F,WAAW,GAAG;MACtBI,QAAQ,EAAED,WAAW;MACrBG,SAAS,EAAED;KACd;IACD,IAAI,CAAC,CAAC,IAAI,CAAClG,MAAM,CAACoG,WAAW,EAAE;MAC3B,IAAI,CAACpG,MAAM,CAACoG,WAAW,CAACC,WAAW,CAACL,WAAW,CAAC;MAChD,IAAI,CAAChG,MAAM,CAACoG,WAAW,CAACE,YAAY,CAACJ,YAAY,CAAC;;EAE1D,CAAC;EAED;EAEA;;;EAGAnE,iDAAyB,GAAzB,UAA0BlB,KAAuB;IAC7C,IAAI,EAAE,CAAC,IAAI,CAACP,MAAM,IAAI,IAAI,CAACN,MAAM,CAAC6D,eAAe,EAAE,CAAC,EAAE;MAClD;MACA,IAAIhD,KAAK,CAACiD,SAAS,KAAK,IAAI,CAAC9D,MAAM,CAAC+D,cAAc,EAAE,EAAE;QAClD;QACAlD,KAAK,CAACiD,SAAS,GAAG,IAAI,CAAC9D,MAAM,CAAC+D,cAAc,EAAE;;;IAGtDlD,KAAK,CAAC0F,QAAQ,GAAG,IAAI;IACrB1F,KAAK,CAAC2F,QAAQ,GAAG,KAAK;IAEtB,IACI1G,QAAQ,CAACmB,eAAe,EAAE,IACzBnB,QAAQ,CAACoB,cAAc,EAAE,KACrBpB,QAAQ,CAACqB,qBAAqB,EAAE,IAC7BrB,QAAQ,CAACsB,mBAAmB,EAAE,IAC9BtB,QAAQ,CAACuB,oBAAoB,EAAE,IAC/BvB,QAAQ,CAACwB,sBAAsB,EAAE,CAAE,EAC7C;MACET,KAAK,CAACU,WAAW,GAAG,IAAI;;IAG5B,IAAI,CAACV,KAAK,CAACE,EAAE,EAAE;MACXF,KAAK,CAACE,EAAE,GAAG,CAAC,IAAI,CAACT,MAAM,GAAG,SAAS,GAAG,QAAQ,IAAI,QAAQ,GAAG,IAAI,CAACN,MAAM,CAACyG,QAAQ;MACjF;MACA,IAAI,CAAC,IAAI,CAAC1F,EAAE,IAAI,CAAC,CAAC,IAAI,CAACd,aAAa,EAAE;QAClC,IAAI,CAACc,EAAE,GAAGF,KAAK,CAACE,EAAE;;;IAI1B,IAAI,IAAI,CAACT,MAAM,IAAI,IAAI,CAACoG,eAAe,CAAC7F,KAAK,CAAC,EAAE;MAC5C;MACA,IAAI,CAAC8F,iBAAiB,CAAC9F,KAAK,CAAC;KAChC,MAAM,IAAI,CAAC,IAAI,CAACP,MAAM,IAAI,CAAC,IAAI,CAACN,MAAM,CAAC6D,eAAe,EAAE,EAAE;MACvD;MACAhD,KAAK,CAAC+F,KAAK,GAAG,IAAI;MAClB,IAAI,IAAI,CAACF,eAAe,CAAC7F,KAAK,CAAC,IAAI,CAAC,IAAI,CAACb,MAAM,CAAC6G,kBAAkB,CAACC,mBAAmB,CAACC,MAAM,EAAE;QAC3F;QACA,IAAI,CAACJ,iBAAiB,CAAC9F,KAAK,CAAC;OAChC,MAAM,IAAI,IAAI,CAACb,MAAM,CAAC6G,kBAAkB,CAACC,mBAAmB,CAACC,MAAM,IAAI,CAAC,IAAI,CAAC/G,MAAM,CAACgH,YAAY,EAAE,EAAE;QACjG;QACA,IAAI,CAACC,WAAW,CAACpG,KAAK,CAAC;;;EAGnC,CAAC;EAED;;;EAGAkB,uCAAe,GAAf;IAAA;IACI,KAAK,IAAImF,CAAC,GAAG,IAAI,CAAClH,MAAM,CAACsD,OAAO,CAACe,cAAc,CAAChB,MAAM,GAAG,CAAC,EAAE6D,CAAC,IAAI,CAAC,EAAE,EAAEA,CAAC,EAAE;MACrE,IAAI,IAAI,CAAClH,MAAM,CAACsD,OAAO,CAACe,cAAc,CAAC6C,CAAC,CAAC,KAAK,IAAI,EAAE;QAChD,IAAI,CAAClH,MAAM,CAACsD,OAAO,CAACe,cAAc,CAAC8C,MAAM,CAACD,CAAC,EAAE,CAAC,CAAC;;;IAIvD,IAAI,CAAC7E,MAAM,CAACmC,OAAO,CAAC,UAAC4C,kBAAkB;MACnC;MACA,IAAI,CAAC,CAACA,kBAAkB,CAACvG,KAAK,IAAI,CAAC,CAACuG,kBAAkB,CAACvG,KAAK,CAACwG,mBAAmB,EAAE;QAC9ED,kBAAkB,CAACvG,KAAK,CAACwG,mBAAmB,CAAC,SAAS,EAAElH,KAAI,CAACsB,eAAe,CAAC;;MAEjF2F,kBAAkB,CAACpG,oBAAoB,GAAG,KAAK;MAC/C,IAAI,CAAC,CAACoG,kBAAkB,CAACnH,aAAa,EAAE;QACpC;QACA;QACAmH,kBAAkB,CAACvG,KAAK,CAACqE,UAAW,CAACoC,WAAW,CAACF,kBAAkB,CAACvG,KAAK,CAAC;QAC1EV,KAAI,CAACwB,EAAE,CAACC,SAAS,CAAC,uBAAuB,EAAE,CACvC,IAAIQ,qCAAiB,CAACgF,kBAAkB,CAACvG,KAAK,EAAEV,KAAI,EAAE,uBAAuB,CAAC,CACjF,CAAC;;MAEN;MACAA,KAAI,CAACoH,eAAe,CAACH,kBAAkB,CAAC;MACxC;MACAjH,KAAI,CAACkC,MAAM,CAACmF,MAAM,CAAC,UAACtD,CAAC;QAAK,QAACA,CAAC,CAACjE,aAAa;MAAhB,CAAgB,CAAC;IAC/C,CAAC,CAAC;EACN,CAAC;EAED;;;EAGA8B,yCAAiB,GAAjB,UAAkBlB,KAAuB;IACrC,IAAI4G,aAAa,GAAG,KAAK;IACzB,KAAK,IAAIP,CAAC,GAAG,CAAC,EAAEA,CAAC,GAAG,IAAI,CAAC7E,MAAM,CAACgB,MAAM,EAAE6D,CAAC,EAAE,EAAE;MACzC,IAAI,IAAI,CAAC7E,MAAM,CAAC6E,CAAC,CAAC,CAACrG,KAAK,KAAKA,KAAK,EAAE;QAChC,IAAI,CAACwB,MAAM,CAAC6E,CAAC,CAAC,CAACrG,KAAK,CAACwG,mBAAmB,CAAC,SAAS,EAAE,IAAI,CAAC5F,eAAe,CAAC;QACzE,IAAI,CAACY,MAAM,CAAC8E,MAAM,CAACD,CAAC,EAAE,CAAC,CAAC;QACxBO,aAAa,GAAG,IAAI;QACpB9H,MAAM,CAAC+E,IAAI,CAAC,mCAAmC,EAAE,IAAI,CAAC;QACtD;;;IAGR,OAAO+C,aAAa;EACxB,CAAC;EAED;;;EAGA1F,gDAAwB,GAAxB;IACI,IAAI,CAAC,CAAC,IAAI,CAACM,MAAM,CAAC,CAAC,CAAC,IAAI,CAAC,CAAC,IAAI,CAACA,MAAM,CAAC,CAAC,CAAC,CAACxB,KAAK,IAAI,CAAC,IAAI,CAACwB,MAAM,CAAC,CAAC,CAAC,CAACrB,oBAAoB,EAAE;MACpF,IAAI,CAAC0G,0CAA0C,EAAE;MACjD,IAAI,CAACrF,MAAM,CAAC,CAAC,CAAC,CAACxB,KAAK,CAAC8G,gBAAgB,CAAC,SAAS,EAAE,IAAI,CAAClG,eAAe,CAAC;MACtE,IAAI,CAACY,MAAM,CAAC,CAAC,CAAC,CAACrB,oBAAoB,GAAG,IAAI;;EAElD,CAAC;EAED;;;EAGAe,yCAAiB,GAAjB,UAAkB6F,WAAwB;IACtC,IAAI,CAACvF,MAAM,CAACmC,OAAO,CAAC,UAAC4C,kBAAkB;MACnCA,kBAAkB,CAACvG,KAAK,CAACiD,SAAS,GAAG8D,WAAW;MAChD,IAAI9H,QAAQ,CAAC+H,UAAU,EAAE,EAAE;QACvB;QACA;QACA,IAAMC,OAAO,GAAGV,kBAAkB,CAACvG,KAAK,CAACkH,aAAa;QACtD,IAAMC,QAAQ,GAAGZ,kBAAkB,CAACvG,KAAK;QACzCiH,OAAS,CAACpC,YAAY,CAACsC,QAAQ,EAAEZ,kBAAkB,CAACvG,KAAK,CAAC;QAC1DuG,kBAAkB,CAACvG,KAAK,GAAGmH,QAAQ;;IAE3C,CAAC,CAAC;EACN,CAAC;EAED;;;EAGAjG,iCAAS,GAAT,UAAUC,IAAY,EAAEiG,UAAiB;IACrC,IAAI,CAACtG,EAAE,CAACC,SAAS,CAACI,IAAI,EAAEiG,UAAU,CAAC;EACvC,CAAC;EAED;;;EAGAlG,mCAAW,GAAX;IACI,OAAOtB,QAAQ,CAACK,aAAa,CAAC,OAAO,CAAC;EAC1C,CAAC;EAED;;;EAGAiB,uCAAe,GAAf,UAAgBqF,kBAAsC;IAClDA,kBAAkB,CAACvG,KAAK,CAACiD,SAAS,GAAG,IAAI;IACzC,IAAI,CAACpC,4CAA4C,EAAE;EACvD,CAAC;EAOD;EAEUK,iDAAyB,GAAnC,UAAoCqF,kBAAsC;IACtE,IAAI,CAAC/E,MAAM,CAAC6F,IAAI,CAACd,kBAAkB,CAAC;IACpC,IAAI,CAACe,wBAAwB,EAAE;IAC/B,IAAI,IAAI,CAACnI,MAAM,CAACsD,OAAO,CAACe,cAAc,CAAC+D,OAAO,CAAC,IAAI,CAAC,KAAK,CAAC,CAAC,EAAE;MACzD,IAAI,CAACpI,MAAM,CAACsD,OAAO,CAACe,cAAc,CAAC6D,IAAI,CAAC,IAAI,CAAC;;EAErD,CAAC;EAEOnG,mCAAW,GAAnB,UAAoBlB,KAAuB;IACvC,IAAI,CAACf,QAAQ,CAAC+H,UAAU,EAAE,EAAE;MACxBhH,KAAK,CAACwH,KAAK,CAACC,SAAS,GAAG,iBAAiB;MACzCzH,KAAK,CAACwH,KAAK,CAACE,eAAe,GAAG,iBAAiB;;EAEvD,CAAC;EAEOxG,yCAAiB,GAAzB,UAA0BlB,KAAuB;IAC7CA,KAAK,CAACwH,KAAK,CAACC,SAAS,GAAG,OAAO;IAC/BzH,KAAK,CAACwH,KAAK,CAACE,eAAe,GAAG,OAAO;EACzC,CAAC;EAEOxG,uCAAe,GAAvB,UAAwBlB,KAAuB;IAC3C,OAAOA,KAAK,CAACwH,KAAK,CAACC,SAAS,KAAK,iBAAiB,IAAIzH,KAAK,CAACwH,KAAK,CAACE,eAAe,KAAK,iBAAiB;EAC3G,CAAC;EAEOxG,kEAA0C,GAAlD;IAAA;IACI,IAAI,CAAC,IAAI,CAACzB,MAAM,EAAE;MACd;MACA;;IAEJ,IAAI,IAAI,CAACkI,kCAAkC,IAAI,IAAI,EAAE;MACjD;MACA;;IAEJ;IACA,IAAMC,SAAS,GAAG,IAAI,CAACzI,MAAM,CAACsD,OAAO,CAACwC,QAAQ,CAACC,qBAAqB,CAAC2C,oCAAoC,IAAI,IAAI;IACjH,IAAI,CAACF,kCAAkC,GAAGG,UAAU,CAAC;MACjD,IAAMC,GAAG,GACL,0BAA0B,GAC1BzI,KAAI,CAACH,MAAM,CAACyG,QAAQ,GACpB,IAAI,IACHtG,KAAI,CAACG,MAAM,GAAG,YAAY,GAAG,WAAW,CAAC,GAC1C,6CAA6C,GAC7CmI,SAAS,GACT,KAAK;MACT9I,MAAM,CAACkJ,IAAI,CAACD,GAAG,CAAC;MAChBzI,KAAI,CAACH,MAAM,CAACsD,OAAO,CAAC1B,SAAS,CAAC,WAAW,EAAE,CACvC,IAAIkH,+BAAc,CAAC3I,KAAI,CAACH,MAAM,CAACsD,OAAO,EAAEwF,mCAAkB,CAACC,uBAAuB,EAAQ5I,KAAmB,EAAEyI,GAAG,CAAC,CACtH,CAAC;MACF,OAAOzI,KAAI,CAACqI,kCAAkC;IAClD,CAAC,EAAEC,SAAS,CAAC;EACjB,CAAC;EAEO1G,oEAA4C,GAApD;IACIiH,YAAY,CAAC,IAAI,CAACR,kCAAyC,CAAC;IAC5D,OAAO,IAAI,CAACA,kCAAkC;EAClD,CAAC;EACL,oBAAC;AAAD,CAAC,CA3jB2CS,iCAAe;AAArCC","names":["logger","OpenViduLogger_1","getInstance","platform","__extends","stream","targetElement","_super","_this","Platform_1","streamManager","remote","isLocal","targEl","document","getElementById","HTMLElement","firstVideoElement","video","createElement","id","canplayListenerAdded","isSafariBrowser","isIPhoneOrIPad","isChromeMobileBrowser","isEdgeMobileBrowser","isOperaMobileBrowser","isFirefoxMobileBrowser","playsInline","element","canPlayListener","deactivateStreamPlayingEventExceptionTimeout","ee","emitEvent","StreamManagerEvent_1","undefined","StreamManager","type","handler","onAux","lazyLaunchVideoElementCreatedEvent","VideoElementEvent_1","videos","currentTime","paused","ended","readyState","hasAudio","enableHarkSpeakingEvent","enableHarkStoppedSpeakingEvent","enableHarkVolumeChangeEvent","onceAux","enableOnceHarkSpeakingEvent","enableOnceHarkStoppedSpeakingEvent","enableOnceHarkVolumeChangeEvent","offAux","remainingStartSpeakingEventListeners","getListeners","length","session","disableHarkSpeakingEvent","remainingStopSpeakingEventListeners","disableHarkStoppedSpeakingEvent","remainingVolumeEventListeners","disableHarkVolumeChangeEvent","initializeVideoProperties","displayMyRemote","srcObject","getMediaStream","_a","_i","v","returnNumber","_c","streamManagers","_b","disassociateVideo","forEach","pushNewStreamManagerVideo","info","insertMode","Error","createVideo","insMode","VideoInsertMode_1","APPEND","AFTER","parentNode","insertBefore","nextSibling","appendChild","BEFORE","PREPEND","childNodes","REPLACE","replaceChild","publisherSpeakingEventsOptions","currentHarkOptions","harkOptions","openvidu","advancedConfiguration","newInterval","interval","newThreshold","threshold","speechEvent","setInterval","setThreshold","autoplay","controls","streamId","isMirroredVideo","removeMirrorVideo","muted","outboundStreamOpts","publisherProperties","mirror","isSendScreen","mirrorVideo","i","splice","streamManagerVideo","removeEventListener","removeChild","removeSrcObject","filter","disassociated","activateStreamPlayingEventExceptionTimeout","addEventListener","mediaStream","isIonicIos","vParent","parentElement","newVideo","eventArray","push","addPlayEventToFirstVideo","indexOf","style","transform","webkitTransform","streamPlayingEventExceptionTimeout","msTimeout","noStreamPlayingEventExceptionTimeout","setTimeout","msg","warn","ExceptionEvent_1","NO_STREAM_PLAYING_EVENT","clearTimeout","EventDispatcher_1","exports"],"sources":["C:\\Users\\user\\Desktop\\openvidu-client\\node_modules\\openvidu-browser\\src\\OpenVidu\\StreamManager.ts"],"sourcesContent":["/*\n * (C) Copyright 2017-2022 OpenVidu (https://openvidu.io)\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *   http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n *\n */\n\nimport { Stream } from './Stream';\nimport { Subscriber } from './Subscriber';\nimport { EventDispatcher } from './EventDispatcher';\nimport { StreamManagerVideo } from '../OpenViduInternal/Interfaces/Public/StreamManagerVideo';\nimport { StreamManagerEventMap } from '../OpenViduInternal/Events/EventMap/StreamManagerEventMap';\nimport { StreamManagerEvent } from '../OpenViduInternal/Events/StreamManagerEvent';\nimport { VideoElementEvent } from '../OpenViduInternal/Events/VideoElementEvent';\nimport { ExceptionEvent, ExceptionEventName } from '../OpenViduInternal/Events/ExceptionEvent';\nimport { VideoInsertMode } from '../OpenViduInternal/Enums/VideoInsertMode';\nimport { OpenViduLogger } from '../OpenViduInternal/Logger/OpenViduLogger';\nimport { PlatformUtils } from '../OpenViduInternal/Utils/Platform';\n\n/**\n * @hidden\n */\nconst logger: OpenViduLogger = OpenViduLogger.getInstance();\n\n/**\n * @hidden\n */\nlet platform: PlatformUtils;\n\n/**\n * Interface in charge of displaying the media streams in the HTML DOM. This wraps any {@link Publisher} and {@link Subscriber} object.\n * You can insert as many video players fo the same Stream as you want by calling {@link StreamManager.addVideoElement} or\n * {@link StreamManager.createVideoElement}.\n * The use of StreamManager wrapper is particularly useful when you don't need to differentiate between Publisher or Subscriber streams or just\n * want to directly manage your own video elements (even more than one video element per Stream). This scenario is pretty common in\n * declarative, MVC frontend frameworks such as Angular, React or Vue.js\n *\n * See available event listeners at {@link StreamManagerEventMap}.\n */\nexport abstract class StreamManager extends EventDispatcher {\n    /**\n     * The Stream represented in the DOM by the Publisher/Subscriber\n     */\n    stream: Stream;\n\n    /**\n     * All the videos displaying the Stream of this Publisher/Subscriber\n     */\n    videos: StreamManagerVideo[] = [];\n\n    /**\n     * Whether the Stream represented in the DOM is local or remote\n     * - `false` for {@link Publisher}\n     * - `true` for {@link Subscriber}\n     */\n    remote: boolean;\n\n    /**\n     * The DOM HTMLElement assigned as target element when creating the video for the Publisher/Subscriber. This property is only defined if:\n     * - {@link Publisher} has been initialized by calling method {@link OpenVidu.initPublisher} with a valid `targetElement` parameter\n     * - {@link Subscriber} has been initialized by calling method {@link Session.subscribe} with a valid `targetElement` parameter\n     */\n    targetElement: HTMLElement;\n\n    /**\n     * `id` attribute of the DOM video element displaying the Publisher/Subscriber's stream. This property is only defined if:\n     * - {@link Publisher} has been initialized by calling method {@link OpenVidu.initPublisher} with a valid `targetElement` parameter\n     * - {@link Subscriber} has been initialized by calling method {@link Session.subscribe} with a valid `targetElement` parameter\n     */\n    id: string;\n\n    /**\n     * @hidden\n     */\n    protected firstVideoElement?: StreamManagerVideo;\n    /**\n     * @hidden\n     */\n    protected element: HTMLElement;\n    /**\n     * @hidden\n     */\n    protected canPlayListener: EventListener;\n    /**\n     * @hidden\n     */\n    private streamPlayingEventExceptionTimeout?: NodeJS.Timeout;\n    /**\n     * @hidden\n     */\n    private lazyLaunchVideoElementCreatedEvent = false;\n\n    /**\n     * @hidden\n     */\n    constructor(stream: Stream, targetElement?: HTMLElement | string) {\n        super();\n        platform = PlatformUtils.getInstance();\n        this.stream = stream;\n        this.stream.streamManager = this;\n        this.remote = !this.stream.isLocal();\n\n        if (!!targetElement) {\n            let targEl;\n            if (typeof targetElement === 'string') {\n                targEl = document.getElementById(targetElement);\n            } else if (targetElement instanceof HTMLElement) {\n                targEl = targetElement;\n            }\n\n            if (!!targEl) {\n                this.firstVideoElement = {\n                    targetElement: targEl,\n                    video: document.createElement('video'),\n                    id: '',\n                    canplayListenerAdded: false\n                };\n                if (\n                    platform.isSafariBrowser() ||\n                    (platform.isIPhoneOrIPad() &&\n                        (platform.isChromeMobileBrowser() ||\n                            platform.isEdgeMobileBrowser() ||\n                            platform.isOperaMobileBrowser() ||\n                            platform.isFirefoxMobileBrowser()))\n                ) {\n                    this.firstVideoElement.video.playsInline = true;\n                }\n                this.targetElement = targEl;\n                this.element = targEl;\n            }\n        }\n\n        this.canPlayListener = () => {\n            this.deactivateStreamPlayingEventExceptionTimeout();\n            this.ee.emitEvent('streamPlaying', [new StreamManagerEvent(this, 'streamPlaying', undefined)]);\n        };\n    }\n\n    /**\n     * See {@link EventDispatcher.on}\n     */\n    on<K extends keyof StreamManagerEventMap>(type: K, handler: (event: StreamManagerEventMap[K]) => void): this {\n        super.onAux(type, \"Event '\" + type + \"' triggered by '\" + (this.remote ? 'Subscriber' : 'Publisher') + \"'\", handler);\n\n        if (type === 'videoElementCreated') {\n            if (!!this.stream && this.lazyLaunchVideoElementCreatedEvent) {\n                this.ee.emitEvent('videoElementCreated', [new VideoElementEvent(this.videos[0].video, this, 'videoElementCreated')]);\n                this.lazyLaunchVideoElementCreatedEvent = false;\n            }\n        }\n        if (type === 'streamPlaying') {\n            if (\n                this.videos[0] &&\n                this.videos[0].video &&\n                this.videos[0].video.currentTime > 0 &&\n                this.videos[0].video.paused === false &&\n                this.videos[0].video.ended === false &&\n                this.videos[0].video.readyState === 4\n            ) {\n                this.ee.emitEvent('streamPlaying', [new StreamManagerEvent(this, 'streamPlaying', undefined)]);\n            }\n        }\n        if (this.stream.hasAudio) {\n            if (type === 'publisherStartSpeaking') {\n                this.stream.enableHarkSpeakingEvent();\n            }\n            if (type === 'publisherStopSpeaking') {\n                this.stream.enableHarkStoppedSpeakingEvent();\n            }\n            if (type === 'streamAudioVolumeChange') {\n                this.stream.enableHarkVolumeChangeEvent(false);\n            }\n        }\n        return this;\n    }\n\n    /**\n     * See {@link EventDispatcher.once}\n     */\n    once<K extends keyof StreamManagerEventMap>(type: K, handler: (event: StreamManagerEventMap[K]) => void): this {\n        super.onceAux(type, \"Event '\" + type + \"' triggered once by '\" + (this.remote ? 'Subscriber' : 'Publisher') + \"'\", handler);\n\n        if (type === 'videoElementCreated') {\n            if (!!this.stream && this.lazyLaunchVideoElementCreatedEvent) {\n                this.ee.emitEvent('videoElementCreated', [new VideoElementEvent(this.videos[0].video, this, 'videoElementCreated')]);\n            }\n        }\n        if (type === 'streamPlaying') {\n            if (\n                this.videos[0] &&\n                this.videos[0].video &&\n                this.videos[0].video.currentTime > 0 &&\n                this.videos[0].video.paused === false &&\n                this.videos[0].video.ended === false &&\n                this.videos[0].video.readyState === 4\n            ) {\n                this.ee.emitEvent('streamPlaying', [new StreamManagerEvent(this, 'streamPlaying', undefined)]);\n            }\n        }\n        if (this.stream.hasAudio) {\n            if (type === 'publisherStartSpeaking') {\n                this.stream.enableOnceHarkSpeakingEvent();\n            }\n            if (type === 'publisherStopSpeaking') {\n                this.stream.enableOnceHarkStoppedSpeakingEvent();\n            }\n            if (type === 'streamAudioVolumeChange') {\n                this.stream.enableOnceHarkVolumeChangeEvent(false);\n            }\n        }\n        return this;\n    }\n\n    /**\n     * See {@link EventDispatcher.off}\n     */\n    off<K extends keyof StreamManagerEventMap>(type: K, handler?: (event: StreamManagerEventMap[K]) => void): this {\n        super.offAux(type, handler);\n\n        if (type === 'publisherStartSpeaking') {\n            // Both StreamManager and Session can have \"publisherStartSpeaking\" event listeners\n            const remainingStartSpeakingEventListeners =\n                this.ee.getListeners(type).length + this.stream.session.ee.getListeners(type).length;\n            if (remainingStartSpeakingEventListeners === 0) {\n                this.stream.disableHarkSpeakingEvent(false);\n            }\n        }\n        if (type === 'publisherStopSpeaking') {\n            // Both StreamManager and Session can have \"publisherStopSpeaking\" event listeners\n            const remainingStopSpeakingEventListeners =\n                this.ee.getListeners(type).length + this.stream.session.ee.getListeners(type).length;\n            if (remainingStopSpeakingEventListeners === 0) {\n                this.stream.disableHarkStoppedSpeakingEvent(false);\n            }\n        }\n        if (type === 'streamAudioVolumeChange') {\n            // Only StreamManager can have \"streamAudioVolumeChange\" event listeners\n            const remainingVolumeEventListeners = this.ee.getListeners(type).length;\n            if (remainingVolumeEventListeners === 0) {\n                this.stream.disableHarkVolumeChangeEvent(false);\n            }\n        }\n\n        return this;\n    }\n\n    /**\n     * Makes `video` element parameter display this {@link stream}. This is useful when you are\n     * [managing the video elements on your own](/en/stable/cheatsheet/manage-videos/#you-take-care-of-the-video-players)\n     *\n     * Calling this method with a video already added to other Publisher/Subscriber will cause the video element to be\n     * disassociated from that previous Publisher/Subscriber and to be associated to this one.\n     *\n     * @returns 1 if the video wasn't associated to any other Publisher/Subscriber and has been successfully added to this one.\n     * 0 if the video was already added to this Publisher/Subscriber. -1 if the video was previously associated to any other\n     * Publisher/Subscriber and has been successfully disassociated from that one and properly added to this one.\n     */\n    addVideoElement(video: HTMLVideoElement): number {\n        this.initializeVideoProperties(video);\n\n        if (!this.remote && this.stream.displayMyRemote()) {\n            if (video.srcObject !== this.stream.getMediaStream()) {\n                video.srcObject = this.stream.getMediaStream();\n            }\n        }\n\n        // If the video element is already part of this StreamManager do nothing\n        for (const v of this.videos) {\n            if (v.video === video) {\n                return 0;\n            }\n        }\n\n        let returnNumber = 1;\n\n        for (const streamManager of this.stream.session.streamManagers) {\n            if (streamManager.disassociateVideo(video)) {\n                returnNumber = -1;\n                break;\n            }\n        }\n\n        this.stream.session.streamManagers.forEach((streamManager) => {\n            streamManager.disassociateVideo(video);\n        });\n\n        this.pushNewStreamManagerVideo({\n            video,\n            id: video.id,\n            canplayListenerAdded: false\n        });\n\n        logger.info('New video element associated to ', this);\n\n        return returnNumber;\n    }\n\n    /**\n     * Creates a new video element displaying this {@link stream}. This allows you to have multiple video elements displaying the same media stream.\n     *\n     * #### Events dispatched\n     *\n     * The Publisher/Subscriber object will dispatch a `videoElementCreated` event once the HTML video element has been added to DOM. See {@link VideoElementEvent}\n     *\n     * @param targetElement HTML DOM element (or its `id` attribute) in which the video element of the Publisher/Subscriber will be inserted\n     * @param insertMode How the video element will be inserted accordingly to `targetElemet`\n     *\n     * @returns The created HTMLVideoElement\n     */\n    createVideoElement(targetElement?: string | HTMLElement, insertMode?: VideoInsertMode): HTMLVideoElement {\n        let targEl;\n        if (typeof targetElement === 'string') {\n            targEl = document.getElementById(targetElement);\n            if (!targEl) {\n                throw new Error(\"The provided 'targetElement' couldn't be resolved to any HTML element: \" + targetElement);\n            }\n        } else if (targetElement instanceof HTMLElement) {\n            targEl = targetElement;\n        } else {\n            throw new Error(\"The provided 'targetElement' couldn't be resolved to any HTML element: \" + targetElement);\n        }\n\n        const video = this.createVideo();\n        this.initializeVideoProperties(video);\n\n        let insMode = !!insertMode ? insertMode : VideoInsertMode.APPEND;\n        switch (insMode) {\n            case VideoInsertMode.AFTER:\n                targEl.parentNode!!.insertBefore(video, targEl.nextSibling);\n                break;\n            case VideoInsertMode.APPEND:\n                targEl.appendChild(video);\n                break;\n            case VideoInsertMode.BEFORE:\n                targEl.parentNode!!.insertBefore(video, targEl);\n                break;\n            case VideoInsertMode.PREPEND:\n                targEl.insertBefore(video, targEl.childNodes[0]);\n                break;\n            case VideoInsertMode.REPLACE:\n                targEl.parentNode!!.replaceChild(video, targEl);\n                break;\n            default:\n                insMode = VideoInsertMode.APPEND;\n                targEl.appendChild(video);\n                break;\n        }\n\n        const v: StreamManagerVideo = {\n            targetElement: targEl,\n            video,\n            insertMode: insMode,\n            id: video.id,\n            canplayListenerAdded: false\n        };\n        this.pushNewStreamManagerVideo(v);\n\n        this.ee.emitEvent('videoElementCreated', [new VideoElementEvent(v.video, this, 'videoElementCreated')]);\n        this.lazyLaunchVideoElementCreatedEvent = !!this.firstVideoElement;\n\n        return video;\n    }\n\n    /**\n     * Updates the current configuration for the {@link PublisherSpeakingEvent} feature and the [StreamManagerEvent.streamAudioVolumeChange](/en/stable/api/openvidu-browser/classes/StreamManagerEvent.html) feature for this specific\n     * StreamManager audio stream, overriding the global options set with {@link OpenVidu.setAdvancedConfiguration}. This way you can customize the audio events options\n     * for each specific StreamManager and change them dynamically.\n     *\n     * @param publisherSpeakingEventsOptions New options to be applied to this StreamManager's audio stream. It is an object which includes the following optional properties:\n     * - `interval`: (number) how frequently the analyser polls the audio stream to check if speaking has started/stopped or audio volume has changed. Default **100** (ms)\n     * - `threshold`: (number) the volume at which _publisherStartSpeaking_, _publisherStopSpeaking_ events will be fired. Default **-50** (dB)\n     */\n    updatePublisherSpeakingEventsOptions(publisherSpeakingEventsOptions: { interval?: number; threshold?: number }): void {\n        const currentHarkOptions = !!this.stream.harkOptions\n            ? this.stream.harkOptions\n            : this.stream.session.openvidu.advancedConfiguration.publisherSpeakingEventsOptions || {};\n        const newInterval =\n            typeof publisherSpeakingEventsOptions.interval === 'number'\n                ? publisherSpeakingEventsOptions.interval\n                : typeof currentHarkOptions.interval === 'number'\n                ? currentHarkOptions.interval\n                : 100;\n        const newThreshold =\n            typeof publisherSpeakingEventsOptions.threshold === 'number'\n                ? publisherSpeakingEventsOptions.threshold\n                : typeof currentHarkOptions.threshold === 'number'\n                ? currentHarkOptions.threshold\n                : -50;\n        this.stream.harkOptions = {\n            interval: newInterval,\n            threshold: newThreshold\n        };\n        if (!!this.stream.speechEvent) {\n            this.stream.speechEvent.setInterval(newInterval);\n            this.stream.speechEvent.setThreshold(newThreshold);\n        }\n    }\n\n    /* Hidden methods */\n\n    /**\n     * @hidden\n     */\n    initializeVideoProperties(video: HTMLVideoElement): void {\n        if (!(!this.remote && this.stream.displayMyRemote())) {\n            // Avoid setting the MediaStream into the srcObject if remote subscription before publishing\n            if (video.srcObject !== this.stream.getMediaStream()) {\n                // If srcObject already set don't do it again\n                video.srcObject = this.stream.getMediaStream();\n            }\n        }\n        video.autoplay = true;\n        video.controls = false;\n\n        if (\n            platform.isSafariBrowser() ||\n            (platform.isIPhoneOrIPad() &&\n                (platform.isChromeMobileBrowser() ||\n                    platform.isEdgeMobileBrowser() ||\n                    platform.isOperaMobileBrowser() ||\n                    platform.isFirefoxMobileBrowser()))\n        ) {\n            video.playsInline = true;\n        }\n\n        if (!video.id) {\n            video.id = (this.remote ? 'remote-' : 'local-') + 'video-' + this.stream.streamId;\n            // DEPRECATED property: assign once the property id if the user provided a valid targetElement\n            if (!this.id && !!this.targetElement) {\n                this.id = video.id;\n            }\n        }\n\n        if (this.remote && this.isMirroredVideo(video)) {\n            // Subscriber video associated to a previously mirrored video element\n            this.removeMirrorVideo(video);\n        } else if (!this.remote && !this.stream.displayMyRemote()) {\n            // Publisher video\n            video.muted = true;\n            if (this.isMirroredVideo(video) && !this.stream.outboundStreamOpts.publisherProperties.mirror) {\n                // If the video was already rotated and now is set to not mirror\n                this.removeMirrorVideo(video);\n            } else if (this.stream.outboundStreamOpts.publisherProperties.mirror && !this.stream.isSendScreen()) {\n                // If the video is now set to mirror and is not screen share\n                this.mirrorVideo(video);\n            }\n        }\n    }\n\n    /**\n     * @hidden\n     */\n    removeAllVideos(): void {\n        for (let i = this.stream.session.streamManagers.length - 1; i >= 0; --i) {\n            if (this.stream.session.streamManagers[i] === this) {\n                this.stream.session.streamManagers.splice(i, 1);\n            }\n        }\n\n        this.videos.forEach((streamManagerVideo) => {\n            // Remove oncanplay event listener (only OpenVidu browser listener, not the user ones)\n            if (!!streamManagerVideo.video && !!streamManagerVideo.video.removeEventListener) {\n                streamManagerVideo.video.removeEventListener('canplay', this.canPlayListener);\n            }\n            streamManagerVideo.canplayListenerAdded = false;\n            if (!!streamManagerVideo.targetElement) {\n                // Only remove from DOM videos created by OpenVidu Browser (those generated by passing a valid targetElement in OpenVidu.initPublisher\n                // and Session.subscribe or those created by StreamManager.createVideoElement). All this videos triggered a videoElementCreated event\n                streamManagerVideo.video.parentNode!.removeChild(streamManagerVideo.video);\n                this.ee.emitEvent('videoElementDestroyed', [\n                    new VideoElementEvent(streamManagerVideo.video, this, 'videoElementDestroyed')\n                ]);\n            }\n            // Remove srcObject from the video\n            this.removeSrcObject(streamManagerVideo);\n            // Remove from collection of videos every video managed by OpenVidu Browser\n            this.videos.filter((v) => !v.targetElement);\n        });\n    }\n\n    /**\n     * @hidden\n     */\n    disassociateVideo(video: HTMLVideoElement): boolean {\n        let disassociated = false;\n        for (let i = 0; i < this.videos.length; i++) {\n            if (this.videos[i].video === video) {\n                this.videos[i].video.removeEventListener('canplay', this.canPlayListener);\n                this.videos.splice(i, 1);\n                disassociated = true;\n                logger.info('Video element disassociated from ', this);\n                break;\n            }\n        }\n        return disassociated;\n    }\n\n    /**\n     * @hidden\n     */\n    addPlayEventToFirstVideo() {\n        if (!!this.videos[0] && !!this.videos[0].video && !this.videos[0].canplayListenerAdded) {\n            this.activateStreamPlayingEventExceptionTimeout();\n            this.videos[0].video.addEventListener('canplay', this.canPlayListener);\n            this.videos[0].canplayListenerAdded = true;\n        }\n    }\n\n    /**\n     * @hidden\n     */\n    updateMediaStream(mediaStream: MediaStream) {\n        this.videos.forEach((streamManagerVideo) => {\n            streamManagerVideo.video.srcObject = mediaStream;\n            if (platform.isIonicIos()) {\n                // iOS Ionic. LIMITATION: must reinsert the video in the DOM for\n                // the media stream to be updated\n                const vParent = streamManagerVideo.video.parentElement;\n                const newVideo = streamManagerVideo.video;\n                vParent!!.replaceChild(newVideo, streamManagerVideo.video);\n                streamManagerVideo.video = newVideo;\n            }\n        });\n    }\n\n    /**\n     * @hidden\n     */\n    emitEvent(type: string, eventArray: any[]): void {\n        this.ee.emitEvent(type, eventArray);\n    }\n\n    /**\n     * @hidden\n     */\n    createVideo(): HTMLVideoElement {\n        return document.createElement('video');\n    }\n\n    /**\n     * @hidden\n     */\n    removeSrcObject(streamManagerVideo: StreamManagerVideo) {\n        streamManagerVideo.video.srcObject = null;\n        this.deactivateStreamPlayingEventExceptionTimeout();\n    }\n\n    /**\n     * @hidden\n     */\n    abstract replaceTrackInMediaStream(track: MediaStreamTrack, updateLastConstraints: boolean): void;\n\n    /* Private methods */\n\n    protected pushNewStreamManagerVideo(streamManagerVideo: StreamManagerVideo) {\n        this.videos.push(streamManagerVideo);\n        this.addPlayEventToFirstVideo();\n        if (this.stream.session.streamManagers.indexOf(this) === -1) {\n            this.stream.session.streamManagers.push(this);\n        }\n    }\n\n    private mirrorVideo(video: HTMLVideoElement): void {\n        if (!platform.isIonicIos()) {\n            video.style.transform = 'rotateY(180deg)';\n            video.style.webkitTransform = 'rotateY(180deg)';\n        }\n    }\n\n    private removeMirrorVideo(video: HTMLVideoElement): void {\n        video.style.transform = 'unset';\n        video.style.webkitTransform = 'unset';\n    }\n\n    private isMirroredVideo(video: HTMLVideoElement): boolean {\n        return video.style.transform === 'rotateY(180deg)' || video.style.webkitTransform === 'rotateY(180deg)';\n    }\n\n    private activateStreamPlayingEventExceptionTimeout() {\n        if (!this.remote) {\n            // ExceptionEvent NO_STREAM_PLAYING_EVENT is only for subscribers\n            return;\n        }\n        if (this.streamPlayingEventExceptionTimeout != null) {\n            // The timeout is already activated\n            return;\n        }\n        // Trigger ExceptionEvent NO_STREAM_PLAYING_EVENT if after timeout there is no 'canplay' event\n        const msTimeout = this.stream.session.openvidu.advancedConfiguration.noStreamPlayingEventExceptionTimeout || 4000;\n        this.streamPlayingEventExceptionTimeout = setTimeout(() => {\n            const msg =\n                'StreamManager of Stream ' +\n                this.stream.streamId +\n                ' (' +\n                (this.remote ? 'Subscriber' : 'Publisher') +\n                ') did not trigger \"streamPlaying\" event in ' +\n                msTimeout +\n                ' ms';\n            logger.warn(msg);\n            this.stream.session.emitEvent('exception', [\n                new ExceptionEvent(this.stream.session, ExceptionEventName.NO_STREAM_PLAYING_EVENT, (<any>this) as Subscriber, msg)\n            ]);\n            delete this.streamPlayingEventExceptionTimeout;\n        }, msTimeout);\n    }\n\n    private deactivateStreamPlayingEventExceptionTimeout() {\n        clearTimeout(this.streamPlayingEventExceptionTimeout as any);\n        delete this.streamPlayingEventExceptionTimeout;\n    }\n}\n"]},"metadata":{},"sourceType":"script","externalDependencies":[]}